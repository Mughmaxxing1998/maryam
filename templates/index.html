<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Letter for You</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Playfair Display -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'sage': '#CCD5AE',
                        'eggshell': '#E9EDC9',
                        'cream': '#FEFAE0',
                        'peach': '#FAEDCD',
                        'tan': '#D4A373',
                        'terracotta-red': '#B85042',
                    },
                    fontFamily: {
                        'serif': ['Playfair Display', 'serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* The main wrapper centers everything and creates the 3D space */
        .envelope-wrapper {
            position: relative;
            width: 32rem; /* 512px */
            height: 20rem; /* 320px */
            max-width: 90vw;
            max-height: 56.25vw;
            margin: auto;
            perspective: 1000px;
        }
        /* Common style for all envelope parts */
        .envelope-part {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            will-change: transform; /* Performance hint for animations */
        }
        .envelope-back {
            background-color: #E9EDC9; /* eggshell */
            z-index: 0;
        }
        .flap {
            background-color: #D4A373; /* tan */
            overflow: hidden;
        }
        .flap::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: #E9EDC9; /* eggshell */
            transform: scale(0.95);
        }
        .flap-left { clip-path: polygon(0% 0%, 50% 50%, 0% 100%); z-index: 2; }
        .flap-left::before { clip-path: polygon(0% 0%, 50% 50%, 0% 100%); }
        .flap-right { clip-path: polygon(100% 0%, 50% 50%, 100% 100%); z-index: 2; }
        .flap-right::before { clip-path: polygon(100% 0%, 50% 50%, 100% 100%); }
        .flap-bottom { clip-path: polygon(0% 100%, 50% 50%, 100% 100%); z-index: 3; }
        .flap-bottom::before { clip-path: polygon(0% 100%, 50% 50%, 100% 100%); }
        .flap-top {
            clip-path: polygon(0% 0%, 50% 50%, 100% 0%);
            transform-origin: top;
            z-index: 3;
            transition: transform 0.7s ease-in-out, z-index 0s 0.7s;
        }
        .flap-top::before { clip-path: polygon(0% 0%, 50% 50%, 100% 0%); }
        .heart-seal {
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            box-shadow: none;
        }

        /* This is the paper that stays behind and animates its size */
        .letter {
            position: absolute;
            background-color: #FEFAE0; /* cream */
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            /* Animate width, height, and position instead of transform */
            transition: width 0.8s, height 0.8s, top 0.8s, left 0.8s;
            transition-timing-function: cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Bounce effect */
        }

        /* Wrapper for the content that fades in */
        .content-wrapper {
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.6s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .content-wrapper.visible { opacity: 1; }

        .letter-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            position: relative; /* Needed for page positioning */
            overflow: hidden; /* Hide sliding pages */
        }

        /* --- PAGE SLIDING ANIMATION --- */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column; /* Allow items to stack vertically */
            align-items: center;
            justify-content: center;
            padding: 2rem;
            /* Default state is off-screen to the right */
            transform: translateX(100%);
            transition: transform 0.6s cubic-bezier(0.45, 0, 0.55, 1);
        }
        .page.active {
            /* Active page is centered */
            transform: translateX(0);
        }
        .page.prev {
            /* Pages that have been passed are off-screen to the left */
            transform: translateX(-100%);
        }

        .pagination-controls {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem 1rem;
            box-sizing: border-box;
        }
        .page-btn {
            background: none; border: none; cursor: pointer; color: #D4A373; transition: color 0.3s;
        }
        .page-btn:hover:not(:disabled) { color: #B85042; }
        .page-btn:disabled { color: #CCD5AE; cursor: not-allowed; }

        /* ---- ANIMATION STATES ---- */
        .flap-top.open { transform: rotateX(180deg); z-index: 0; }
        .heart-seal.open { opacity: 0; transform: scale(0.5); }
        .fall {
             transition: transform 1.5s cubic-bezier(0.95, 0.05, 0.795, 0.035);
             transform: translateY(150vh);
        }
        .flap-top.fall { transform: translateY(150vh) rotateX(180deg); }

        /* --- GAME OF 15 STYLES --- */
        .game-title {
            font-family: 'Playfair Display', serif;
            color: #D4A373;
            font-size: 2.25rem; /* text-4xl */
            font-style: italic;
            margin-bottom: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .game-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            width: 90%; /* Adjust as needed */
            max-width: 400px; /* Max size of the game */
            aspect-ratio: 1 / 1; /* Keep it square */
            gap: 5px;
            padding: 5px;
            background-color: #D4A373; /* tan */
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-bottom: 1.5rem; /* Space between game and buttons */
        }
        .game-tile {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #FEFAE0; /* cream */
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease-in-out; /* This enables the animation */
            overflow: hidden; /* Ensure images don't spill out */
        }
        .game-tile img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Cover the tile area */
            /* --- ADDED STYLES TO PREVENT DRAGGING/HIGHLIGHTING --- */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE10+/Edge */
            user-select: none;         /* Standard */
            pointer-events: none;      /* Prevent direct interaction with the image itself */
        }
        .game-tile.blank {
            background-color: #CCD5AE; /* sage, or a slightly darker shade of game-container */
            cursor: default;
        }
        .win-message {
            margin-top: 1.5rem; /* Space between reset button and message */
        }

        .game-controls {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .game-button {
            font-family: 'Playfair Display', serif;
            color: #D4A373;
            background-color: #FEFAE0;
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            border: 2px solid #D4A373;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .game-button:hover {
            background-color: #D4A373;
            color: #FEFAE0;
        }

    </style>
</head>
<body class="bg-peach font-serif antialiased overflow-hidden">

    <div class="min-h-screen flex items-center justify-center">
        <div id="envelope-wrapper" class="envelope-wrapper cursor-pointer">
            <!-- Envelope parts -->
            <div id="envelope-back" class="envelope-part envelope-back"></div>
            <div id="flap-left" class="envelope-part flap flap-left"></div>
            <div id="flap-right" class="envelope-part flap flap-right"></div>
            <div id="flap-bottom" class="envelope-part flap flap-bottom"></div>
            <div id="flap-top" class="envelope-part flap flap-top"></div>
            <div id="heart" class="envelope-part heart-seal">
                <svg class="w-20 h-20 text-terracotta-red" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
            </div>
        </div>
    </div>

    <script>
        const wrapper = document.getElementById('envelope-wrapper');
        const flapTop = document.getElementById('flap-top');
        const heart = document.getElementById('heart');

        const fallingParts = Array.from(document.querySelectorAll('.envelope-part'));

        const pageContents = [
             // --- MODIFIED GAME PAGE STRUCTURE ---
            `
                <h2 class="game-title">LOBSTAR!!!</h2>
                <div id='game-of-15-placeholder'></div>
                <div class="game-controls">
                    <button id="reset-btn" class="game-button">Reset</button>
                </div>
            `,
            "This is the second page, after the puzzle!",
            "More content can go here...",
            "And here as well.",
            "The final page."
        ];
        let currentPage = 0;
        let isOpen = false;
        let gameInitialized = false;

        // --- GAME OF 15 LOGIC ---
        const GRID_SIZE = 4;
        let board = [];
        let blankPos = { row: -1, col: -1 };

        function countInversions(arr) {
            let inversions = 0;
            const flatArr = arr.filter(num => num !== 0);
            for (let i = 0; i < flatArr.length - 1; i++) {
                for (let j = i + 1; j < flatArr.length; j++) {
                    if (flatArr[i] > flatArr[j]) {
                        inversions++;
                    }
                }
            }
            return inversions;
        }

        function isSolvable(tiles, blankRow) {
            const inversions = countInversions(tiles);
            const blankRowFromBottom = GRID_SIZE - blankRow;
            if (inversions % 2 !== 0) {
                return blankRowFromBottom % 2 === 0;
            } else {
                return blankRowFromBottom % 2 !== 0;
            }
        }

        function shuffleBoard() {
            let tiles = Array.from({ length: GRID_SIZE * GRID_SIZE - 1 }, (_, i) => i + 1);
            tiles.push(0);

            do {
                for (let i = tiles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
                }
                const blankIndex = tiles.indexOf(0);
            } while (!isSolvable(tiles, Math.floor(tiles.indexOf(0) / GRID_SIZE)));

            board = [];
            for (let i = 0; i < GRID_SIZE; i++) {
                board.push(tiles.slice(i * GRID_SIZE, (i + 1) * GRID_SIZE));
            }

            const blankIndex = tiles.indexOf(0);
            blankPos = { row: Math.floor(blankIndex / GRID_SIZE), col: blankIndex % GRID_SIZE };
        }


        function renderBoard(container) {
            container.innerHTML = '';
            container.style.display = 'grid';

            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const tileValue = board[r][c];
                    const tileElement = document.createElement('div');
                    tileElement.classList.add('game-tile');
                    if (tileValue === 0) {
                        tileElement.classList.add('blank');
                    } else {
                        const img = document.createElement('img');
                        img.src = `static/split_images/${tileValue}.png`;
                        img.alt = `Tile ${tileValue}`;
                        img.draggable = false;
                        tileElement.appendChild(img);
                        tileElement.addEventListener('click', () => handleTileClick(r, c));
                    }
                    container.appendChild(tileElement);
                }
            }
            if (checkWinCondition()) {
                displayWinMessage();
            }
        }

        function handleTileClick(r, c) {
            const dr = Math.abs(r - blankPos.row);
            const dc = Math.abs(c - blankPos.col);

            const gameContainer = document.querySelector('#game-of-15-placeholder .game-container');
            if (!gameContainer) return;

            if ((dr === 1 && dc === 0) || (dr === 0 && dc === 1)) {
                const clickedTileIndex = r * GRID_SIZE + c;
                const clickedTileElement = gameContainer.children[clickedTileIndex];

                if (!clickedTileElement) return;

                const translateX = (blankPos.col - c) * 100;
                const translateY = (blankPos.row - r) * 100;

                clickedTileElement.style.transform = `translate(${translateX}%, ${translateY}%)`;
                clickedTileElement.style.zIndex = '10';
                gameContainer.style.pointerEvents = 'none';

                setTimeout(() => {
                    board[blankPos.row][blankPos.col] = board[r][c];
                    board[r][c] = 0;
                    blankPos = { row: r, col: c };
                    renderBoard(gameContainer);
                    gameContainer.style.pointerEvents = 'auto';
                }, 200);
            }
        }


        function checkWinCondition() {
            let current = 1;
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    if (r === GRID_SIZE - 1 && c === GRID_SIZE - 1) {
                        return board[r][c] === 0;
                    }
                    if (board[r][c] !== current) {
                        return false;
                    }
                    current++;
                }
            }
            return true;
        }

        function displayWinMessage() {
            // Find the game controls container
            const gameControls = document.querySelector('.game-controls');
            if (!gameControls) return;

            // Check if a win message already exists to avoid duplicates
            if (document.querySelector('.win-message')) return;

            const message = document.createElement('div');
            message.className = 'win-message text-4xl italic text-tan drop-shadow-lg';
            message.textContent = 'Congratulations! You solved it!';

            // Insert the message after the game controls container
            gameControls.parentNode.insertBefore(message, gameControls.nextSibling);
        }

        function initializeGame() {
            if (gameInitialized) return;
            const placeholder = document.getElementById('game-of-15-placeholder');
            if (!placeholder) {
                console.error("Game placeholder not found!");
                return;
            }

            const gameContainer = document.createElement('div');
            gameContainer.className = 'game-container';
            placeholder.appendChild(gameContainer);

            shuffleBoard();
            renderBoard(gameContainer);
            gameInitialized = true;
        }
        // --- END GAME OF 15 LOGIC ---


        wrapper.addEventListener('click', () => {
            if (isOpen) return;
            isOpen = true;

            wrapper.classList.remove('cursor-pointer');

            const letter = document.createElement('div');
            letter.className = 'letter';
            letter.style.top = '0';
            letter.style.left = '0';
            letter.style.width = '100%';
            letter.style.height = '100%';
            wrapper.appendChild(letter);

            flapTop.classList.add('open');
            heart.classList.add('open');

            setTimeout(() => {
                fallingParts.forEach(part => part.classList.add('fall'));

                setTimeout(() => {
                    fallingParts.forEach(part => part.style.display = 'none');
                }, 1500);

            }, 700);

            setTimeout(() => {
                const finalWidthRem = 80;
                const finalHeightRem = 50;
                const initialWidthRem = 32;
                const initialHeightRem = 20;

                letter.style.width = `${finalWidthRem}rem`;
                letter.style.height = `${finalHeightRem}rem`;
                letter.style.top = `-${(finalHeightRem - initialHeightRem) / 2}rem`;
                letter.style.left = `-${(finalWidthRem - initialWidthRem) / 2}rem`;
            }, 2200);

            setTimeout(() => {
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'content-wrapper';

                let pagesHTML = pageContents.map((content, index) => {
                    if (index > 0) {
                        return `<div class="page">
                                    <p class="text-4xl italic text-tan drop-shadow-lg">${content}</p>
                                </div>`;
                    }
                    // For the game page, the content is already structured
                    return `<div class="page">${content}</div>`;
                }).join('');

                contentWrapper.innerHTML = `
                    <div class="letter-content">${pagesHTML}</div>
                    <div class="pagination-controls">
                        <button class="page-btn" id="prev-btn">
                            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <span id="page-indicator" class="text-tan text-lg"></span>
                        <button class="page-btn" id="next-btn">
                            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                `;

                letter.appendChild(contentWrapper);
                setTimeout(() => contentWrapper.classList.add('visible'), 50);

                const prevButton = document.getElementById('prev-btn');
                const nextButton = document.getElementById('next-btn');
                const pageIndicator = document.getElementById('page-indicator');
                const pages = letter.querySelectorAll('.page');

                function updatePaging() {
                    pages.forEach((page, index) => {
                        page.classList.remove('active', 'prev');
                        if (index === currentPage) {
                            page.classList.add('active');
                            if (currentPage === 0 && !gameInitialized) {
                                initializeGame();
                            }
                        } else if (index < currentPage) {
                            page.classList.add('prev');
                        }
                    });
                    pageIndicator.textContent = `${currentPage + 1} / ${pageContents.length}`;
                    prevButton.disabled = currentPage === 0;
                    // --- REMOVED LOCK LOGIC ---
                    nextButton.disabled = currentPage === pageContents.length - 1;
                }

                prevButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (currentPage > 0) {
                        currentPage--;
                        updatePaging();
                    }
                });

                nextButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (currentPage < pageContents.length - 1) {
                        currentPage++;
                        updatePaging();
                    }
                });

                const resetButton = document.getElementById('reset-btn');

                if(resetButton) {
                    resetButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const gameContainer = document.querySelector('#game-of-15-placeholder .game-container');
                        const winMessage = document.querySelector('.win-message');
                        if(winMessage) winMessage.remove();
                        shuffleBoard();
                        renderBoard(gameContainer);
                    });
                }

                updatePaging(); // Initial setup
            }, 3000);
        });
    </script>

</body>
</html>
